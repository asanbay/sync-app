<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>üìö –°–∏—Å—Ç–µ–º–∞ –£—á—ë—Ç–∞ –ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π - ENHANCED PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        /* –ú–ù–û–ì–û–£–†–û–í–ù–ï–í–´–ï –¢–ï–ú–´ */
        :root {
            /* –ë–ê–ó–û–í–ê–Ø –¢–ï–ú–ê - –°–ò–ù–Ø–Ø */
            --primary: #2b79b8;
            --primary-dark: #1e5c96;
            --success: #10b981;
            --success-dark: #059669;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --info: #3b82f6;
            --bg-primary: #071023;
            --bg-secondary: #0b1220;
            --bg-card: #0c1724;
            --bg-hover: rgba(96, 165, 250, 0.1);
            --text-primary: #e6eef8;
            --text-secondary: #9fbffd;
            --border: #333;
            --accent: #60a5fa;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
            --radius: 12px;
        }

        /* –°–ò–ù–Ø–Ø –¢–ï–ú–ê */
        body.blue-theme {
            --primary: #2b79b8;
            --primary-dark: #1e5c96;
            --accent: #60a5fa;
            --bg-primary: #071023;
            --bg-secondary: #0b1220;
            --bg-card: #0c1724;
        }

        /* –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê */
        body.dark-theme {
            --primary: #6b7280;
            --primary-dark: #4b5563;
            --accent: #9ca3af;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-card: #374151;
        }

        /* –ó–ï–õ–ï–ù–ê–Ø –¢–ï–ú–ê */
        body.green-theme {
            --primary: #059669;
            --primary-dark: #047857;
            --accent: #34d399;
            --bg-primary: #052e16;
            --bg-secondary: #064e3b;
            --bg-card: #065f46;
        }

        /* –§–ò–û–õ–ï–¢–û–í–ê–Ø –¢–ï–ú–ê */
        body.purple-theme {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --accent: #a78bfa;
            --bg-primary: #1e1b4b;
            --bg-secondary: #312e81;
            --bg-card: #4338ca;
        }

        /* –ö–†–ê–°–ù–ê–Ø –¢–ï–ú–ê */
        body.red-theme {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --accent: #f87171;
            --bg-primary: #450a0a;
            --bg-secondary: #7f1d1d;
            --bg-card: #991b1b;
        }

        /* –°–í–ï–¢–õ–´–ï –¢–ï–ú–´ */
        body.light-theme {
            --bg-primary: #f0f4f8;
            --bg-secondary: #e1e8f0;
            --bg-card: #ffffff;
            --bg-hover: rgba(96, 165, 250, 0.1);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border: #cbd5e1;
            --accent: #2563eb;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body.light-blue {
            --primary: #2b79b8;
            --accent: #3b82f6;
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f2fe;
            --bg-card: #ffffff;
        }

        body.light-green {
            --primary: #059669;
            --accent: #10b981;
            --bg-primary: #f0fdf4;
            --bg-secondary: #dcfce7;
            --bg-card: #ffffff;
        }

        body.light-purple {
            --primary: #7c3aed;
            --accent: #8b5cf6;
            --bg-primary: #faf5ff;
            --bg-secondary: #f3e8ff;
            --bg-card: #ffffff;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 20px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        .container { max-width: 1800px; margin: 0 auto; }
        
        header {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-right { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        h1 { 
            font-size: 26px; 
            background: linear-gradient(135deg, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .user-badge {
            background: linear-gradient(135deg, var(--primary), var(--info));
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: var(--bg-card);
            padding: 10px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .tab-btn:hover { 
            background: var(--bg-hover);
            color: var(--accent);
            transform: translateY(-2px);
        }
        
        .tab-btn.active { 
            background: linear-gradient(135deg, var(--primary), var(--info));
            color: white;
            box-shadow: 0 4px 8px rgba(43, 121, 184, 0.3);
        }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .btn:hover { 
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .btn:active { transform: translateY(0); }
        
        .btn-success { background: var(--success); }
        .btn-success:hover { background: var(--success-dark); }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: var(--danger-dark); }
        .btn-warning { background: var(--warning); }
        .btn-warning:hover { background: var(--warning-dark); }
        .btn-info { background: var(--info); }
        .btn-info:hover { background: #2563eb; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        select, input, textarea {
            background: rgba(12, 23, 36, 0.8);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th { 
            background: rgba(26, 42, 58, 0.7);
            font-weight: 600;
        }
        
        tr { transition: all 0.2s; }
        tr:hover { background: var(--bg-hover); }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-done { 
            background: rgba(16, 185, 129, 0.2); 
            color: #86efac;
            border: 1px solid rgba(134, 239, 172, 0.3);
        }
        .badge-started { 
            background: rgba(59, 130, 246, 0.2); 
            color: #93c5fd;
            border: 1px solid rgba(147, 197, 253, 0.3);
        }
        .badge-pending { 
            background: rgba(245, 158, 11, 0.2); 
            color: #fcd34d;
            border: 1px solid rgba(252, 211, 77, 0.3);
        }
        
        .btn.badge-done:hover { background: rgba(16, 185, 129, 0.4); }
        .btn.badge-started:hover { background: rgba(59, 130, 246, 0.4); }
        .btn.badge-pending:hover { background: rgba(245, 158, 11, 0.4); }
        
        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius);
            max-width: 600px;
            width: 90%;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .modal-content h2 { margin-bottom: 20px; color: var(--accent); }
        
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat {
            background: linear-gradient(135deg, rgba(43, 121, 184, 0.1), rgba(59, 130, 246, 0.1));
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            border-left: 4px solid var(--accent);
            transition: all 0.3s;
        }
        
        .stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        
        .stat-value { 
            font-size: 32px; 
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px;
            font-weight: 500;
        }
        
        .stat-icon {
            font-size: 24px;
            opacity: 0.3;
            margin-bottom: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(12, 23, 36, 0.5);
            border-radius: var(--radius);
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
        }
        
        .history-day {
            background: rgba(51, 65, 85, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .history-day:hover { border-color: var(--accent); }
        
        .history-day-header {
            padding: 12px;
            background: rgba(96, 165, 250, 0.1);
            cursor: pointer;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-day-content {
            display: none;
            padding: 12px;
        }
        
        .history-day-content.show { display: block; }
        
        .history-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(51, 65, 85, 0.2);
            border-left: 3px solid var(--accent);
            border-radius: 6px;
            font-size: 12px;
        }
        
        h3 { 
            margin-top: 25px; 
            margin-bottom: 15px;
            color: var(--accent);
            font-size: 18px;
        }
        
        .category-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .category-item input { flex: 1; }
        
        .kpi-card {
            background: linear-gradient(135deg, rgba(43, 121, 184, 0.2), rgba(59, 130, 246, 0.2));
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            border: 1px solid var(--accent);
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .kpi-item {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent);
        }
        
        .kpi-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--info));
            transition: width 0.5s;
        }
        
        .settings-section {
            background: rgba(15, 23, 36, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent);
        }
        
        .settings-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .read-only-notice {
            background: var(--warning);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-input-group input {
            flex: 1;
        }

        .task-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .task-type-instruction {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(147, 197, 253, 0.3);
        }

        .task-type-routine {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border: 1px solid rgba(196, 181, 253, 0.3);
        }

        .analytics-section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .analytics-section h3 {
            margin-top: 0;
            color: var(--accent);
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .analytics-card {
            background: rgba(12, 23, 36, 0.5);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
        }

        .analytics-card h4 {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .analytics-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: var(--bg-hover);
        }

        .editable-field {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .editable-field:hover {
            background: rgba(96, 165, 250, 0.2);
        }

        .edit-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid var(--accent);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-preview:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }

        .theme-preview.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .theme-option {
            text-align: center;
        }

        .theme-name {
            font-size: 12px;
            margin-top: 5px;
            color: var(--text-secondary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-grid { grid-template-columns: 1fr; }
            h1 { font-size: 20px; }
            .theme-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body class="blue-theme">

<div class="container">
    <header>
        <div class="header-left">
            <h1>üìö –°–∏—Å—Ç–µ–º–∞ –£—á—ë—Ç–∞ –ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π - PRO</h1>
            <div class="user-badge" id="userDisplay">üë§ –ê—Å–∞–Ω–±–µ–∫</div>
        </div>
        <div class="header-right">
            <button class="btn btn-success" onclick="showModal('addTaskModal')">
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
            </button>
            <button class="btn btn-warning" onclick="doExport()">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn btn-info" onclick="doExportJSON()">
                <i class="fas fa-file-code"></i> JSON
            </button>
            <select onchange="changeUser()" id="userSelect">
                <option value="asanbek">–ê—Å–∞–Ω–±–µ–∫</option>
                <option value="akylbek">–ê–∫—ã–ª–±–µ–∫</option>
                <option value="oka">üëÅ –û–∫–∞ (–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å)</option>
            </select>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'tasks')">üìã –ó–∞–¥–∞—á–∏</button>
        <button class="tab-btn" onclick="openTab(event, 'dashboard')"><i class="fas fa-chart-line"></i> –î–∞—à–±–æ—Ä–¥</button>
        <button class="tab-btn" onclick="openTab(event, 'analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        <button class="tab-btn" onclick="openTab(event, 'testing')">‚úì –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <button class="tab-btn" onclick="openTab(event, 'history')">üïê –ò—Å—Ç–æ—Ä–∏—è</button>
        <button class="tab-btn" onclick="openTab(event, 'settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <!-- –ó–ê–î–ê–ß–ò -->
    <div id="tasks" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">–ó–∞–¥–∞—á–∏</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <small style="color: var(--text-secondary); font-size: 11px;">
                        üí° –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –Ω–∞–∑–≤–∞–Ω–∏–π
                    </small>
                </div>
            </div>

            <div class="filter-group">
                <select id="filterCategory" onchange="showTasks()" style="max-width: 200px;">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                </select>
                <select id="filterStatus" onchange="showTasks()" style="max-width: 200px;">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="–û–∂–∏–¥–∞–Ω–∏–µ">–û–∂–∏–¥–∞–Ω–∏–µ</option>
                    <option value="–ù–∞—á–∞—Ç–æ">–ù–∞—á–∞—Ç–æ</option>
                    <option value="–í—ã–ø–æ–ª–Ω–µ–Ω–æ">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                </select>
                <select id="filterTaskType" onchange="showTasks()" style="max-width: 200px;">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="instruction">–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏</option>
                    <option value="routine">–†—É—Ç–∏–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</option>
                </select>
            </div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                            <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                            <th>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</th>
                            <th>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                            <th>–ó–∞—Ç—Ä–∞—á–µ–Ω–æ</th>
                            <th>–¢–∏–ø</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</th>
                            <th style="min-width: 180px;">–°—Ç–∞—Ç—É—Å / –î–µ–π—Å—Ç–≤–∏—è</th>
                            <th>üóëÔ∏è</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTable">
                        <tr><td colspan="12">–ù–µ—Ç –∑–∞–¥–∞—á</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –î–ê–®–ë–û–†–î -->
    <div id="dashboard" class="tab-content">
        <div class="kpi-card">
            <h2>üìä KPI –ü–∞–Ω–µ–ª—å</h2>
            <div class="kpi-grid" id="kpiGrid"></div>
        </div>

        <div class="stats-grid">
            <div class="stat">
                <div class="stat-icon">üìö</div>
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
            </div>
            <div class="stat">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="completedTasks">0</div>
                <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>
            <div class="stat">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-value" id="inProgressTasks">0</div>
                <div class="stat-label">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
            </div>
            <div class="stat">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value" id="totalHours">0</div>
                <div class="stat-label">–ß–∞—Å–æ–≤ –æ–±—É—á–µ–Ω–∏—è</div>
            </div>
            <div class="stat">
                <div class="stat-icon">üë§</div>
                <div class="stat-value" id="statAsanbek">0</div>
                <div class="stat-label">–ê—Å–∞–Ω–±–µ–∫</div>
            </div>
            <div class="stat">
                <div class="stat-icon">üë§</div>
                <div class="stat-value" id="statAkylbek">0</div>
                <div class="stat-label">–ê–∫—ã–ª–±–µ–∫</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
                </div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üéØ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìä –¢–µ–Ω–¥–µ–Ω—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
            </div>
            <div class="chart-container">
                <canvas id="weeklyTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
    <div id="analytics" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                <div class="controls">
                    <select id="analyticsPeriod" onchange="showAdvancedAnalytics()" style="max-width: 200px;">
                        <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                        <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
                        <option value="quarter">–ó–∞ –∫–≤–∞—Ä—Ç–∞–ª</option>
                        <option value="year">–ó–∞ –≥–æ–¥</option>
                    </select>
                    <select id="analyticsTaskType" onchange="showAdvancedAnalytics()" style="max-width: 200px;">
                        <option value="all">–í—Å–µ –∑–∞–¥–∞—á–∏</option>
                        <option value="instruction">–¢–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏</option>
                        <option value="routine">–¢–æ–ª—å–∫–æ —Ä—É—Ç–∏–Ω–Ω—ã–µ</option>
                    </select>
                </div>
            </div>
            <div id="advancedAnalyticsContent"></div>
        </div>

        <div class="chart-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üë• –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤</h3>
                </div>
                <div class="chart-container">
                    <canvas id="instructorChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –∑–∞–¥–∞—á</h3>
                </div>
                <div class="chart-container">
                    <canvas id="taskTypeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
            </div>
            <div class="chart-container">
                <canvas id="efficiencyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï -->
    <div id="testing" class="tab-content">
        <div class="card">
            <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            
            <div class="filter-group">
                <button class="btn btn-sm" onclick="showModal('eIsotModal')">–ï–ò–°–û–¢</button>
                <button class="btn btn-warning btn-sm" onclick="showModal('prombezModal')">–ü—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</button>
                <button class="btn btn-success btn-sm" onclick="showModal('ndTestingModal')">–ù–î —Ç–µ—Å—Ç—ã</button>
            </div>

            <h3>–ò—Å—Ç–æ—Ä–∏—è –ï–ò–°–û–¢</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</th>
                            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            <th>–í—Ä–µ–º—è (–º–∏–Ω)</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="eIsotTable"></tbody>
                </table>
            </div>

            <h3>–ò—Å—Ç–æ—Ä–∏—è –ü—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="prombezTable"></tbody>
                </table>
            </div>

            <h3>–ò—Å—Ç–æ—Ä–∏—è –ù–î —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="ndTestingTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –ò–°–¢–û–†–ò–Ø -->
    <div id="history" class="tab-content">
        <div class="card">
            <h2>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h2>
            
            <div class="filter-group">
                <select id="historyFilter" onchange="renderHistory()" style="max-width: 200px;">
                    <option value="">–í—Å–µ</option>
                    <option value="asanbek">–ê—Å–∞–Ω–±–µ–∫</option>
                    <option value="akylbek">–ê–∫—ã–ª–±–µ–∫</option>
                    <option value="oka">–û–∫–∞</option>
                </select>
            </div>

            <div id="historyContainer"></div>
        </div>
    </div>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div id="settings" class="tab-content">
        <div class="card">
            <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>

            <!-- –ù–ê–°–¢–†–û–ô–ö–ò –¢–ï–ú–´ -->
            <div class="settings-section">
                <h4>üé® –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h4>
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:</label>
                    <div class="theme-grid">
                        <div class="theme-option">
                            <div class="theme-preview blue-theme" style="background: linear-gradient(135deg, #071023 0%, #0b1220 100%);" onclick="changeTheme('blue-theme')"></div>
                            <div class="theme-name">–°–∏–Ω—è—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</div>
                        </div>
                        <div class="theme-option">
                            <div class="theme-preview dark-theme" style="background: linear-gradient(135deg, #111827 0%, #1f2937 100%);" onclick="changeTheme('dark-theme')"></div>
                            <div class="theme-name">–¢—ë–º–Ω–∞—è</div>
                        </div>
                        <div class="theme-option">
                            <div class="theme-preview green-theme" style="background: linear-gradient(135deg, #052e16 0%, #064e3b 100%);" onclick="changeTheme('green-theme')"></div>
                            <div class="theme-name">–ó–µ–ª—ë–Ω–∞—è</div>
                        </div>
                        <div class="theme-option">
                            <div class="theme-preview purple-theme" style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);" onclick="changeTheme('purple-theme')"></div>
                            <div class="theme-name">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è</div>
                        </div>
                        <div class="theme-option">
                            <div class="theme-preview red-theme" style="background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);" onclick="changeTheme('red-theme')"></div>
                            <div class="theme-name">–ö—Ä–∞—Å–Ω–∞—è</div>
                        </div>
                        <div class="theme-option">
                            <div class="theme-preview light-blue" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);" onclick="changeTheme('light-blue')"></div>
                            <div class="theme-name">–°–≤–µ—Ç–ª–æ-—Å–∏–Ω—è—è</div>
                        </div>
                        <div class="theme-option">
                            <div class="theme-preview light-green" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);" onclick="changeTheme('light-green')"></div>
                            <div class="theme-name">–°–≤–µ—Ç–ª–æ-–∑–µ–ª—ë–Ω–∞—è</div>
                        </div>
                        <div class="theme-option">
                            <div class="theme-preview light-purple" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);" onclick="changeTheme('light-purple')"></div>
                            <div class="theme-name">–°–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° GOOGLE SHEETS -->
            <div class="settings-section">
                <h4>‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets</h4>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="syncToCloud()">
                        <i class="fas fa-cloud-upload-alt"></i> ‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ
                    </button>
                    <button class="btn btn-warning" onclick="syncFromCloud()">
                        <i class="fas fa-cloud-download-alt"></i> ‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
                    </button>
                </div>
                
                <div style="margin-top: 10px; padding: 10px; background: rgba(96, 165, 250, 0.1); border-radius: 6px;">
                    <small style="color: var(--text-secondary);">
                        üí° <strong>–ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</strong> –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                    </small>
                </div>

                <div id="syncStatus" style="margin-top: 10px; padding: 8px; border-radius: 6px; display: none;"></div>
            </div>

            <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò -->
            <div class="settings-section">
                <h4>üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h4>
                <p style="color: #9fbffd; font-size: 12px; margin-bottom: 10px;">–î–æ–±–∞–≤–ª—è–π—Ç–µ, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–π—Ç–µ –∏–ª–∏ —É–¥–∞–ª—è–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</p>
                <div id="mainCategoriesManager"></div>
                <div style="margin-top: 15px;">
                    <div class="category-item">
                        <input type="text" id="newCategoryName" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è">
                        <button class="btn btn-success btn-sm" onclick="addNewCategory()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h4>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h4>
                <p style="color: #9fbffd; font-size: 12px; margin-bottom: 10px;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏:</p>
                <div id="categoriesManager"></div>
            </div>

            <div class="settings-section">
                <h4>üß™ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ –ù–î —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                <p style="color: #9fbffd; font-size: 12px; margin-bottom: 10px;">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∏–ª–∏ —É–¥–∞–ª—è–π—Ç–µ —Ç–∏–ø—ã —Ç–µ—Å—Ç–æ–≤:</p>
                <div id="ndTestTypesManager"></div>
            </div>

            <div class="settings-section">
                <h4>üíæ –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç</h4>
                <div class="form-group">
                    <label>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON:</label>
                    <input type="file" id="importFile" accept=".json">
                    <button class="btn btn-success" onclick="importFromFile()">
                        <i class="fas fa-upload"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É -->
<div id="addTaskModal" class="modal">
    <div class="modal-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h2>
        <div class="form-group">
            <label>–¢–∏–ø –∑–∞–¥–∞—á–∏:</label>
            <select id="taskType">
                <option value="instruction">–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂</option>
                <option value="routine">–†—É—Ç–∏–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞</option>
            </select>
        </div>
        <div class="form-group">
            <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
            <input type="date" id="taskDateStart">
        </div>
        <div class="form-group">
            <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
            <input type="date" id="taskDateEnd">
        </div>
        <div class="form-group">
            <label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>
            <input type="time" id="taskTimeStart">
        </div>
        <div class="form-group">
            <label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
            <input type="time" id="taskTimeEnd">
        </div>
        <div class="form-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <select id="taskCategory" onchange="updateSubcategories()">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
            </select>
        </div>
        <div class="form-group">
            <label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <select id="taskSubcategory" onchange="toggleCustomSubcategory()">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
            </select>
        </div>
        <div class="form-group" id="customSubcategoryGroup" style="display: none;">
            <label>–ù–æ–≤–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <input type="text" id="taskCustomSubcategory" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
        </div>
        <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="taskName" list="taskNameSuggestions" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π">
            <datalist id="taskNameSuggestions"></datalist>
        </div>
        <div class="form-group">
            <label>–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:</label>
            <select id="taskInstructor">
                <option value="asanbek">–ê—Å–∞–Ω–±–µ–∫</option>
                <option value="akylbek">–ê–∫—ã–ª–±–µ–∫</option>
            </select>
        </div>
        <div class="form-group">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="taskStatus">
                <option value="–û–∂–∏–¥–∞–Ω–∏–µ">–û–∂–∏–¥–∞–Ω–∏–µ</option>
                <option value="–ù–∞—á–∞—Ç–æ">–ù–∞—á–∞—Ç–æ</option>
                <option value="–í—ã–ø–æ–ª–Ω–µ–Ω–æ">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
            </select>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="closeModal('addTaskModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="addTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ï–ò–°–û–¢ -->
<div id="eIsotModal" class="modal">
    <div class="modal-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –ï–ò–°–û–¢</h2>
        <div class="form-group">
            <label>–î–∞—Ç–∞:</label>
            <input type="date" id="eIsotDate">
        </div>
        <div class="form-group">
            <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
            <input type="text" id="eIsotEmployee">
        </div>
        <div class="form-group">
            <label>–í—Ä–µ–º—è (–º–∏–Ω):</label>
            <input type="number" id="eIsotTime">
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="closeModal('eIsotModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="addEIsot()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ü—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
<div id="prombezModal" class="modal">
    <div class="modal-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –ü—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
        <div class="form-group">
            <label>–î–∞—Ç–∞:</label>
            <input type="date" id="prombezDate">
        </div>
        <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="prombezDescription" rows="3"></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="closeModal('prombezModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="addPrombez()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ù–î —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
<div id="ndTestingModal" class="modal">
    <div class="modal-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –ù–î —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <div class="form-group">
            <label>–î–∞—Ç–∞:</label>
            <input type="date" id="ndTestDate">
        </div>
        <div class="form-group">
            <label>–¢–∏–ø:</label>
            <select id="ndTestType">
                <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </select>
        </div>
        <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="ndTestDesc" rows="3"></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="closeModal('ndTestingModal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="addNDTesting()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
// ============= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =============
var currentUser = 'asanbek';
var tasks = [];
var eIsotResults = [];
var prombezResults = [];
var ndTestingResults = [];
var fullHistory = [];
var categories = {
    "–ü—Ä–∏—ë–º—ã –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤":["–ü—Ä–∏–∫–∞–∑—ã","–ò–û–¢-–û–ü–†","–í–≤–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞","–ù–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ","–ñ—É—Ä–Ω–∞–ª—ã –≠–ë","–ü–æ–∂–∞—Ä–Ω—ã–π (–≤–≤–æ–¥–Ω—ã–π)","–ü–æ–∂–∞—Ä–Ω—ã–π (–ø–µ—Ä–≤–∏—á–Ω—ã–π)","–£–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –£–ß","QR –∫–æ–¥—ã –∏ —Ñ–æ—Ç–æ","–°—Ç–∞–∂–∏—Ä–æ–≤–∫–∞","–¢—Ä–µ–π–Ω–∏–Ω–≥ –∫–∞—Ä—Ç","–ü—Ä–æ—Ü–µ–¥—É—Ä—ã","–ü—Ä–æ–∏–∑–≤. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏","–†–µ–µ—Å—Ç—Ä –ú–∏–Ω—Ç—Ä—É–¥","‚ûï –î—Ä—É–≥–æ–µ"],
    "–î–æ–ø –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏":["–†–∞–±–æ—á–∏–π –ª—é–ª—å–∫–∏-–ü—Ä–∏–∫–∞–∑","–†–∞–±–æ—á–∏–π –ª—é–ª—å–∫–∏-–ü—Ä–æ—Ç–æ–∫–æ–ª","–†–∞–±–æ—á–∏–π –ª—é–ª—å–∫–∏-–£–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ","–ú–∞—à–∏–Ω–∏—Å—Ç—ã –ê–ì–ü-–ü—Ä–∏–∫–∞–∑","–ú–∞—à–∏–Ω–∏—Å—Ç—ã –ê–ì–ü-–ò–û–¢","–ú–∞—à–∏–Ω–∏—Å—Ç—ã –ê–ì–ü-–°—Ç–∞–∂–∏—Ä–æ–≤–∫–∞","–ú–∞—à–∏–Ω–∏—Å—Ç—ã –ê–ì–ü-–£–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ","–û–ó–ü-–ü—Ä–∏–∫–∞–∑","–û–óP-–ò–û–¢","–û–ó–ü-–°—Ç–∞–∂–∏—Ä–æ–≤–∫–∞","–û–ó–ü-–û–±—É—á–µ–Ω–∏–µ –≤ –∫–ª–∞—Å—Å–µ","‚ûï –î—Ä—É–≥–æ–µ"],
    "–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏":["–î–µ–Ω—å 1 - –í–≤–æ–¥–Ω—ã–π","–î–µ–Ω—å 2 - –ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å","–î–µ–Ω—å 3 - –û–≥–Ω–µ–≤—ã–µ —Ä–∞–±–æ—Ç—ã","–î–µ–Ω—å 4 - –†–∞–±–æ—Ç–∞ –ø–æ –ù–î","–î–µ–Ω—å 5 - –†–∞–±–æ—Ç–∞ –Ω–∞ –≤—ã—Å–æ—Ç–µ","–ú–∞—à–∏–Ω–∏—Å—Ç—ã –ê–ì–ü","–†–∞–±–æ—á–∏–π –ª—é–ª—å–∫–∏","–û–ó–ü","–°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏","‚ûï –î—Ä—É–≥–æ–µ"],
    "–û–±—É—á–µ–Ω–∏–µ":["–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –≠–ë","–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω–∞ –≤—ã—Å–æ—Ç–µ","–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ù–î","–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –≥—Ä—É–∑–æ–ø–æ–¥—ä—ë–º","–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –∑–µ–º–ª—è–Ω—ã–µ —Ä–∞–±–æ—Ç—ã","–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å","‚ûï –î—Ä—É–≥–æ–µ"],
    "–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ–±—É—á–µ–Ω–∏—è":["–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ-–í –≤—ã—Å–æ—Ç–∞","–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ-–≠–ë","–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ-–î–æ–ø –ø—Ä–æ—Ñ","‚ûï –î—Ä—É–≥–æ–µ"],
    "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ":["–ï–ò–°–û–¢ –¥–ª—è –°–û–¢","–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å","‚ûï –î—Ä—É–≥–æ–µ"]
};

var ndTestTypes = [
    "–¢–µ—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ –ù–î",
    "–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –∏ —Ç–µ—Å—Ç –ø–æ –ù–î",
    "–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –∏ —Ç–µ—Å—Ç –ø–æ –≤—ã—Å–æ—Ç–µ",
    "–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –∏ —Ç–µ—Å—Ç –ø–æ –≠–ë",
    "–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –∏ —Ç–µ—Å—Ç –ø–æ –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º—É"
];

var statusChartInstance = null;
var categoryChartInstance = null;
var weeklyTrendChartInstance = null;
var instructorChartInstance = null;
var taskTypeChartInstance = null;
var efficiencyChartInstance = null;

// ============= –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ URL –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô URL –ò–ó GOOGLE APPS SCRIPT =============
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5Dg8TwLEZr4ACrbuSPplCpKQ6k1ws-p4JuUjfBECEdlXKmtdpbJ1ISFfuXyzFzBncmQ/exec';

// ============= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –í–†–ï–ú–ï–ù–ï–ú (–ß–ß:–ú–ú) =============
function timeToMinutes(timeStr) {
    if (!timeStr || timeStr === '0:00') return 0;
    var parts = timeStr.split(':');
    var hours = parseInt(parts[0]) || 0;
    var minutes = parseInt(parts[1]) || 0;
    return hours * 60 + minutes;
}

function minutesToTime(minutes) {
    var hours = Math.floor(minutes / 60);
    var mins = minutes % 60;
    return hours + ':' + (mins < 10 ? '0' + mins : mins);
}

function minutesToDecimalHours(minutes) {
    return (minutes / 60).toFixed(2);
}

// ============= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –î–ê–¢–ê–ú–ò =============
function formatDateForDisplay(dateStr) {
    if (!dateStr) return '';
    var parts = dateStr.split('-');
    if (parts.length === 3) {
        return parts[2] + '.' + parts[1] + '.' + parts[0];
    }
    return dateStr;
}

function formatDateForInput(dateStr) {
    if (!dateStr) return '';
    var parts = dateStr.split('.');
    if (parts.length === 3) {
        return parts[2] + '-' + parts[1] + '-' + parts[0];
    }
    return dateStr;
}

function getTodayDate() {
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0');
    var yyyy = today.getFullYear();
    return yyyy + '-' + mm + '-' + dd;
}

function getCurrentTime() {
    var now = new Date();
    var hh = String(now.getHours()).padStart(2, '0');
    var mm = String(now.getMinutes()).padStart(2, '0');
    return hh + ':' + mm;
}

// ============= –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø =============
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

// ============= –ú–ù–û–ì–û–£–†–û–í–ù–ï–í–´–ï –¢–ï–ú–´ =============
function changeTheme(theme) {
    document.body.className = theme;
    localStorage.setItem('theme', theme);
    
    var themePreviews = document.querySelectorAll('.theme-preview');
    themePreviews.forEach(function(preview) {
        preview.classList.remove('selected');
        if (preview.parentElement.querySelector('.theme-name').textContent.includes(theme.replace('-theme', '').replace('-', ' '))) {
            preview.classList.add('selected');
        }
    });
}

function loadTheme() {
    var savedTheme = localStorage.getItem('theme') || 'blue-theme';
    changeTheme(savedTheme);
}

// ============= –†–ï–ñ–ò–ú –¢–û–õ–¨–ö–û –ß–¢–ï–ù–ò–Ø –î–õ–Ø –û–ö–ê =============
function updateUIBasedOnPermissions() {
    var isReadOnly = currentUser === 'oka';
    
    var actionButtons = document.querySelectorAll('.btn-success, .btn-warning, .btn-danger');
    actionButtons.forEach(function(btn) {
        if (btn.classList.contains('btn-info') || btn.innerText.includes('Excel') || btn.innerText.includes('JSON')) {
            return;
        }
        btn.style.display = isReadOnly ? 'none' : '';
    });
    
    var inputs = document.querySelectorAll('#tasksTable input, #tasksTable select');
    inputs.forEach(function(input) {
        input.disabled = isReadOnly;
    });
    
    if (isReadOnly) {
        if (!document.getElementById('readOnlyNotice')) {
            var notice = document.createElement('div');
            notice.id = 'readOnlyNotice';
            notice.className = 'read-only-notice';
            notice.innerHTML = 'üëÅ <strong>–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</strong> - –≤—ã –º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ';
            document.querySelector('header').after(notice);
        }
    } else {
        var notice = document.getElementById('readOnlyNotice');
        if (notice) notice.remove();
    }
}

// ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =============
async function init() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
    const cloudSuccess = await syncFromCloud();
    
    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
    if (!cloudSuccess) {
        loadData();
        showNotification('üìÇ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞', 'info');
    }
    
    changeUser();
    populateCategories();
    showTasks();
    updateStats();
    loadTheme();
    updateTaskNameSuggestions();
    
    console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
}

function loadData() {
    try {
        tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        eIsotResults = JSON.parse(localStorage.getItem('eIsotResults')) || [];
        prombezResults = JSON.parse(localStorage.getItem('prombezResults')) || [];
        ndTestingResults = JSON.parse(localStorage.getItem('ndTestingResults')) || [];
        fullHistory = JSON.parse(localStorage.getItem('fullHistory')) || [];
        var savedCategories = JSON.parse(localStorage.getItem('categories'));
        if (savedCategories) categories = savedCategories;
        var savedNdTestTypes = JSON.parse(localStorage.getItem('ndTestTypes'));
        if (savedNdTestTypes) ndTestTypes = savedNdTestTypes;
        
        // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        tasks.forEach(function(task) {
            if (task.hoursSpent !== undefined && task.hoursMinutes === undefined) {
                task.hoursMinutes = Math.round(task.hoursSpent * 60);
                delete task.hoursSpent;
            }
            if (!task.dateStart) {
                task.dateStart = task.date || getTodayDate();
            }
            if (!task.dateEnd && task.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ') {
                task.dateEnd = task.date || getTodayDate();
            }
            if (!task.taskType) {
                task.taskType = 'instruction';
            }
        });
    } catch(e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
    }
}

function saveData() {
    try {
        localStorage.setItem('tasks', JSON.stringify(tasks));
        localStorage.setItem('eIsotResults', JSON.stringify(eIsotResults));
        localStorage.setItem('prombezResults', JSON.stringify(prombezResults));
        localStorage.setItem('ndTestingResults', JSON.stringify(ndTestingResults));
        localStorage.setItem('fullHistory', JSON.stringify(fullHistory));
        localStorage.setItem('categories', JSON.stringify(categories));
        localStorage.setItem('ndTestTypes', JSON.stringify(ndTestTypes));
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º
        syncToCloud().catch(error => {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –æ–±–ª–∞–∫–æ–º:', error);
        });
    } catch(e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
    }
}

function changeUser() {
    currentUser = document.getElementById('userSelect').value;
    document.getElementById('userDisplay').textContent = 'üë§ ' + 
        (currentUser === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : 
         currentUser === 'akylbek' ? '–ê–∫—ã–ª–±–µ–∫' : 'üëÅ –û–∫–∞ (–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å)');
    document.getElementById('taskInstructor').value = currentUser === 'oka' ? 'asanbek' : currentUser;
    
    updateUIBasedOnPermissions();
}

function populateCategories() {
    var catSelect = document.getElementById('taskCategory');
    var filterSelect = document.getElementById('filterCategory');
    
    catSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
    filterSelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
    
    for (var cat in categories) {
        catSelect.innerHTML += '<option value="' + cat + '">' + cat + '</option>';
        filterSelect.innerHTML += '<option value="' + cat + '">' + cat + '</option>';
    }
}

function updateSubcategories() {
    var cat = document.getElementById('taskCategory').value;
    var subSelect = document.getElementById('taskSubcategory');
    subSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
    
    if (cat && categories[cat]) {
        categories[cat].forEach(function(sub) {
            subSelect.innerHTML += '<option value="' + sub + '">' + sub + '</option>';
        });
    }
}

function toggleCustomSubcategory() {
    var subcat = document.getElementById('taskSubcategory').value;
    var customGroup = document.getElementById('customSubcategoryGroup');
    
    if (subcat === '‚ûï –î—Ä—É–≥–æ–µ') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
}

// ============= –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –î–õ–Ø –ù–ê–ó–í–ê–ù–ò–ô =============
function updateTaskNameSuggestions() {
    var datalist = document.getElementById('taskNameSuggestions');
    datalist.innerHTML = '';
    
    var uniqueNames = [...new Set(tasks.map(task => task.name))];
    
    var popularNames = [
        "–í–≤–æ–¥–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂",
        "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂",
        "–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂",
        "–í–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂",
        "–¶–µ–ª–µ–≤–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂",
        "–û–±—É—á–µ–Ω–∏–µ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞",
        "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π",
        "–°—Ç–∞–∂–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ",
        "–û–±—É—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –º–µ—Ç–æ–¥–∞–º —Ä–∞–±–æ—Ç—ã",
        "–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –ø–æ –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
    ];
    
    var allNames = [...new Set([...popularNames, ...uniqueNames])];
    
    allNames.forEach(function(name) {
        var option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
    });
}

// ============= –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê =============
function showModal(id) {
    var modal = document.getElementById(id);
    modal.classList.add('show');
    
    if (id === 'addTaskModal') {
        var today = getTodayDate();
        document.getElementById('taskDateStart').value = today;
        document.getElementById('taskDateEnd').value = '';
        document.getElementById('taskTimeStart').value = getCurrentTime();
        document.getElementById('taskTimeEnd').value = '';
        document.getElementById('taskInstructor').value = currentUser === 'oka' ? 'asanbek' : currentUser;
        document.getElementById('taskStatus').value = '–û–∂–∏–¥–∞–Ω–∏–µ';
        document.getElementById('taskType').value = 'instruction';
        updateTaskNameSuggestions();
    }
    if (id === 'eIsotModal') {
        document.getElementById('eIsotDate').value = getTodayDate();
    }
    if (id === 'prombezModal') {
        document.getElementById('prombezDate').value = getTodayDate();
    }
    if (id === 'ndTestingModal') {
        document.getElementById('ndTestDate').value = getTodayDate();
        populateNdTestTypes();
    }
}

function populateNdTestTypes() {
    var select = document.getElementById('ndTestType');
    select.innerHTML = '';
    ndTestTypes.forEach(function(type) {
        select.innerHTML += '<option value="' + type + '">' + type + '</option>';
    });
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

// ============= –ó–ê–î–ê–ß–ò =============
function addTask() {
    var dateStart = document.getElementById('taskDateStart').value;
    var dateEnd = document.getElementById('taskDateEnd').value;
    var timeStart = document.getElementById('taskTimeStart').value;
    var timeEnd = document.getElementById('taskTimeEnd').value;
    var taskType = document.getElementById('taskType').value;
    var cat = document.getElementById('taskCategory').value;
    var subcat = document.getElementById('taskSubcategory').value;
    var customSubcat = document.getElementById('taskCustomSubcategory').value.trim();
    var name = document.getElementById('taskName').value.trim();
    var inst = document.getElementById('taskInstructor').value;
    var status = document.getElementById('taskStatus').value;
    
    if (!dateStart || !cat || !name) {
        showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'error');
        return;
    }

    if (subcat === '‚ûï –î—Ä—É–≥–æ–µ' && customSubcat) {
        subcat = customSubcat;
        if (categories[cat].indexOf(customSubcat) === -1) {
            categories[cat][categories[cat].length - 1] = customSubcat;
            categories[cat].push('‚ûï –î—Ä—É–≥–æ–µ');
        }
    } else if (!subcat || subcat === '‚ûï –î—Ä—É–≥–æ–µ') {
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é!', 'error');
        return;
    }
    
    if (status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' && !dateEnd) {
        dateEnd = getTodayDate();
    }
    
    if (status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' && !timeEnd) {
        timeEnd = getCurrentTime();
    }
    
    var actualMinutes = 0;
    
    if (timeStart && timeEnd) {
        var startParts = timeStart.split(':');
        var endParts = timeEnd.split(':');
        var startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
        var endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
        actualMinutes = endMinutes - startMinutes;
        
        if (actualMinutes < 0) {
            actualMinutes += 24 * 60;
        }
    }
    
    tasks.push({
        id: Date.now(),
        dateStart: dateStart,
        dateEnd: dateEnd,
        timeStart: timeStart,
        timeEnd: timeEnd,
        taskType: taskType,
        category: cat,
        subcategory: subcat,
        name: name,
        actualMinutes: actualMinutes,
        assignedTo: inst,
        status: status,
        createdAt: new Date().toISOString(),
        startedAt: status === '–ù–∞—á–∞—Ç–æ' ? new Date().toISOString() : null,
        completedAt: status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' ? new Date().toISOString() : null
    });
    
    saveData();
    closeModal('addTaskModal');
    showTasks();
    addToFullHistory('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + name + ' (' + (taskType === 'instruction' ? '–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂' : '–†—É—Ç–∏–Ω–Ω–∞—è') + ')');
    document.getElementById('taskCustomSubcategory').value = '';
    updateTaskNameSuggestions();
    showNotification('‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
}

function deleteTask(id) {
    var task = tasks.find(function(t) { return t.id === id; });
    if (!task) return;
    
    if (task.assignedTo !== currentUser && currentUser !== 'oka') {
        showNotification('‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }
    
    var message = '‚ö†Ô∏è –í–´ –£–í–ï–†–ï–ù–´ –ß–¢–û –•–û–¢–ò–¢–ï –£–î–ê–õ–ò–¢–¨ –≠–¢–£ –ó–ê–ü–ò–°–¨?\n\n';
    message += 'üìÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: ' + formatDateForDisplay(task.dateStart) + '\n';
    if (task.dateEnd) message += 'üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ' + formatDateForDisplay(task.dateEnd) + '\n';
    message += 'üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ' + task.category + '\n';
    message += 'üìÇ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ' + task.subcategory + '\n';
    message += 'üìù –ù–∞–∑–≤–∞–Ω–∏–µ: ' + task.name + '\n';
    message += 'üë§ –ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: ' + (task.assignedTo === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫') + '\n';
    message += 'üìä –°—Ç–∞—Ç—É—Å: ' + task.status + '\n\n';
    message += '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!';
    
    if (confirm(message)) {
        tasks = tasks.filter(function(t) { return t.id !== id; });
        saveData();
        showTasks();
        addToFullHistory('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞: ' + task.name + ' (' + task.category + ' - ' + task.subcategory + ')');
        showNotification('üóëÔ∏è –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
    }
}

// ============= –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –í –¢–ê–ë–õ–ò–¶–ï =============
function showTasks() {
    var catFilter = document.getElementById('filterCategory').value;
    var statusFilter = document.getElementById('filterStatus').value;
    var taskTypeFilter = document.getElementById('filterTaskType').value;
    
    var filtered = tasks.filter(function(t) {
        if (catFilter && t.category !== catFilter) return false;
        if (statusFilter && t.status !== statusFilter) return false;
        if (taskTypeFilter && t.taskType !== taskTypeFilter) return false;
        return true;
    }).sort(function(a, b) {
        return new Date(a.dateStart) - new Date(b.dateStart);
    });

    var html = '';
    filtered.forEach(function(task) {
        var badgeClass = task.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' ? 'badge-done' : 
                        task.status === '–ù–∞—á–∞—Ç–æ' ? 'badge-started' : 'badge-pending';
        var taskTypeBadge = task.taskType === 'instruction' ? 
            '<span class="task-type-badge task-type-instruction">–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂</span>' : 
            '<span class="task-type-badge task-type-routine">–†—É—Ç–∏–Ω–Ω–∞—è</span>';
        
        html += '<tr>';
        html += '<td><input type="date" value="' + task.dateStart + '" onchange="updateTaskDateStart(' + task.id + ', this.value)" style="width: 130px;"></td>';
        html += '<td><input type="date" value="' + (task.dateEnd || '') + '" onchange="updateTaskDateEnd(' + task.id + ', this.value)" style="width: 130px;"></td>';
        html += '<td><input type="time" value="' + (task.timeStart || '') + '" onchange="updateTaskTimeStart(' + task.id + ', this.value)" style="width: 100px;"></td>';
        html += '<td><input type="time" value="' + (task.timeEnd || '') + '" onchange="updateTaskTimeEnd(' + task.id + ', this.value)" style="width: 100px;"></td>';
        html += '<td>' + (task.actualMinutes ? minutesToTime(task.actualMinutes) : '-') + '</td>';
        html += '<td>' + taskTypeBadge + '</td>';
        
        html += '<td><span class="editable-field" ondblclick="editCategory(' + task.id + ', this)">' + task.category + '</span></td>';
        html += '<td><span class="editable-field" ondblclick="editSubcategory(' + task.id + ', this)">' + task.subcategory + '</span></td>';
        html += '<td><span class="editable-field" ondblclick="editTaskName(' + task.id + ', this)">' + task.name + '</span></td>';
        
        html += '<td>' + (task.assignedTo === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫') + '</td>';
        
        html += '<td><div style="display: flex; gap: 5px; flex-wrap: wrap;">';
        if (task.status !== '–û–∂–∏–¥–∞–Ω–∏–µ') {
            html += '<button class="btn btn-sm badge-pending" onclick="changeTaskStatus(' + task.id + ', \'–û–∂–∏–¥–∞–Ω–∏–µ\')" title="–û–∂–∏–¥–∞–Ω–∏–µ" style="padding: 4px 8px;">‚è∏Ô∏è</button>';
        }
        if (task.status !== '–ù–∞—á–∞—Ç–æ') {
            html += '<button class="btn btn-sm badge-started" onclick="changeTaskStatus(' + task.id + ', \'–ù–∞—á–∞—Ç–æ\')" title="–ù–∞—á–∞—Ç–æ" style="padding: 4px 8px;">‚ñ∂Ô∏è</button>';
        }
        if (task.status !== '–í—ã–ø–æ–ª–Ω–µ–Ω–æ') {
            html += '<button class="btn btn-sm badge-done" onclick="changeTaskStatus(' + task.id + ', \'–í—ã–ø–æ–ª–Ω–µ–Ω–æ\')" title="–í—ã–ø–æ–ª–Ω–µ–Ω–æ" style="padding: 4px 8px;">‚úÖ</button>';
        }
        html += '<span class="badge ' + badgeClass + '" style="padding: 4px 8px;">' + task.status + '</span>';
        html += '</div></td>';
        
        html += '<td><button class="btn btn-danger btn-sm" onclick="deleteTask(' + task.id + ')"><i class="fas fa-trash"></i></button></td>';
        html += '</tr>';
    });

    document.getElementById('tasksTable').innerHTML = html || '<tr><td colspan="12">–ù–µ—Ç –∑–∞–¥–∞—á</td></tr>';
    updateStats();
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function editCategory(taskId, element) {
    var task = tasks.find(function(t) { return t.id === taskId; });
    if (!task) return;
    
    var currentValue = task.category;
    var selectHtml = '<select class="edit-input" onblur="saveCategory(' + taskId + ', this.value)" onkeypress="if(event.key===\'Enter\') this.blur()">';
    
    for (var cat in categories) {
        selectHtml += '<option value="' + cat + '"' + (cat === currentValue ? ' selected' : '') + '>' + cat + '</option>';
    }
    
    selectHtml += '</select>';
    element.innerHTML = selectHtml;
    element.querySelector('select').focus();
}

function saveCategory(taskId, newCategory) {
    var task = tasks.find(function(t) { return t.id === taskId; });
    if (task && newCategory && newCategory !== task.category) {
        var oldCategory = task.category;
        task.category = newCategory;
        task.subcategory = categories[newCategory][0] || '‚ûï –î—Ä—É–≥–æ–µ';
        
        saveData();
        showTasks();
        addToFullHistory('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞: "' + task.name + '" —Å "' + oldCategory + '" –Ω–∞ "' + newCategory + '"');
    } else {
        showTasks();
    }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function editSubcategory(taskId, element) {
    var task = tasks.find(function(t) { return t.id === taskId; });
    if (!task) return;
    
    var currentValue = task.subcategory;
    var categorySubcats = categories[task.category] || [];
    
    var selectHtml = '<select class="edit-input" onblur="saveSubcategory(' + taskId + ', this.value)" onkeypress="if(event.key===\'Enter\') this.blur()">';
    
    categorySubcats.forEach(function(subcat) {
        selectHtml += '<option value="' + subcat + '"' + (subcat === currentValue ? ' selected' : '') + '>' + subcat + '</option>';
    });
    
    selectHtml += '</select>';
    element.innerHTML = selectHtml;
    element.querySelector('select').focus();
}

function saveSubcategory(taskId, newSubcategory) {
    var task = tasks.find(function(t) { return t.id === taskId; });
    if (task && newSubcategory && newSubcategory !== task.subcategory) {
        var oldSubcategory = task.subcategory;
        task.subcategory = newSubcategory;
        saveData();
        showTasks();
        addToFullHistory('–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞: "' + task.name + '" —Å "' + oldSubcategory + '" –Ω–∞ "' + newSubcategory + '"');
    } else {
        showTasks();
    }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
function editTaskName(taskId, element) {
    var task = tasks.find(function(t) { return t.id === taskId; });
    if (!task) return;
    
    var currentValue = task.name;
    element.innerHTML = '<input class="edit-input" type="text" value="' + currentValue + '" onblur="saveTaskName(' + taskId + ', this.value)" onkeypress="if(event.key===\'Enter\') this.blur()">';
    element.querySelector('input').focus();
    element.querySelector('input').select();
}

function saveTaskName(taskId, newName) {
    var task = tasks.find(function(t) { return t.id === taskId; });
    if (task && newName && newName.trim() !== '' && newName !== task.name) {
        var oldName = task.name;
        task.name = newName.trim();
        saveData();
        showTasks();
        updateTaskNameSuggestions();
        addToFullHistory('–ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ: —Å "' + oldName + '" –Ω–∞ "' + newName + '"');
    } else {
        showTasks();
    }
}

function updateTaskDateStart(id, newDate) {
    var task = tasks.find(function(t) { return t.id === id; });
    if (task) {
        var oldDate = task.dateStart;
        task.dateStart = newDate;
        saveData();
        addToFullHistory('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: "' + task.name + '" —Å ' + formatDateForDisplay(oldDate) + ' –Ω–∞ ' + formatDateForDisplay(newDate));
    }
}

function updateTaskDateEnd(id, newDate) {
    var task = tasks.find(function(t) { return t.id === id; });
    if (task) {
        var oldDate = task.dateEnd;
        task.dateEnd = newDate || null;
        saveData();
        addToFullHistory('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞: "' + task.name + '" —Å ' + formatDateForDisplay(oldDate) + ' –Ω–∞ ' + formatDateForDisplay(newDate));
    }
}

function updateTaskTimeStart(id, newTime) {
    var task = tasks.find(function(t) { return t.id === id; });
    if (task) {
        var oldTime = task.timeStart;
        task.timeStart = newTime;
        
        if (task.timeEnd) {
            calculateActualTime(task);
        }
        
        saveData();
        addToFullHistory('–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–æ: "' + task.name + '" —Å ' + oldTime + ' –Ω–∞ ' + newTime);
    }
}

function updateTaskTimeEnd(id, newTime) {
    var task = tasks.find(function(t) { return t.id === id; });
    if (task) {
        var oldTime = task.timeEnd;
        task.timeEnd = newTime;
        
        if (task.timeStart) {
            calculateActualTime(task);
        }
        
        saveData();
        addToFullHistory('–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–æ: "' + task.name + '" —Å ' + oldTime + ' –Ω–∞ ' + newTime);
    }
}

function calculateActualTime(task) {
    if (task.timeStart && task.timeEnd) {
        var startParts = task.timeStart.split(':');
        var endParts = task.timeEnd.split(':');
        var startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
        var endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
        task.actualMinutes = endMinutes - startMinutes;
        
        if (task.actualMinutes < 0) {
            task.actualMinutes += 24 * 60;
        }
    }
}

function changeTaskStatus(id, newStatus) {
    var task = tasks.find(function(t) { return t.id === id; });
    if (task) {
        var oldStatus = task.status;
        task.status = newStatus;
        
        if (newStatus === '–ù–∞—á–∞—Ç–æ' && !task.startedAt) {
            task.startedAt = new Date().toISOString();
            if (!task.timeStart) {
                task.timeStart = getCurrentTime();
            }
        }
        if (newStatus === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' && !task.completedAt) {
            task.completedAt = new Date().toISOString();
            if (!task.dateEnd) {
                task.dateEnd = getTodayDate();
            }
            if (!task.timeEnd) {
                task.timeEnd = getCurrentTime();
                if (task.timeStart) {
                    calculateActualTime(task);
                }
            }
        }
        
        saveData();
        showTasks();
        addToFullHistory('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω: "' + task.name + '" —Å "' + oldStatus + '" –Ω–∞ "' + newStatus + '"');
    }
}

// ============= –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï =============
function addEIsot() {
    var date = document.getElementById('eIsotDate').value;
    var emp = document.getElementById('eIsotEmployee').value.trim();
    var time = parseInt(document.getElementById('eIsotTime').value) || 0;
    
    if (!date || !emp) {
        showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
        return;
    }
    
    eIsotResults.push({
        id: Date.now(),
        date: date,
        instructor: currentUser,
        employee: emp,
        time: time
    });
    
    saveData();
    closeModal('eIsotModal');
    renderEIsot();
    addToFullHistory('–ï–ò–°–û–¢ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–ª—è ' + emp);
    showNotification('‚úÖ –ï–ò–°–û–¢ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
}

function renderEIsot() {
    var html = '';
    eIsotResults.sort(function(a, b) {
        return new Date(a.date) - new Date(b.date);
    }).forEach(function(r) {
        html += '<tr>';
        html += '<td>' + formatDateForDisplay(r.date) + '</td>';
        html += '<td>' + (r.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫') + '</td>';
        html += '<td>' + r.employee + '</td>';
        html += '<td>' + r.time + '</td>';
        html += '<td><button class="btn btn-danger btn-sm" onclick="deleteEIsot(' + r.id + ')"><i class="fas fa-trash"></i></button></td>';
        html += '</tr>';
    });
    document.getElementById('eIsotTable').innerHTML = html || '<tr><td colspan="5">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
}

function deleteEIsot(id) {
    var record = eIsotResults.find(function(r) { return r.id === id; });
    if (!record) return;
    
    if (record.instructor !== currentUser && currentUser !== 'oka') {
        showNotification('‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }
    
    var message = '‚ö†Ô∏è –í–´ –£–í–ï–†–ï–ù–´ –ß–¢–û –•–û–¢–ò–¢–ï –£–î–ê–õ–ò–¢–¨ –≠–¢–£ –ó–ê–ü–ò–°–¨ –ï–ò–°–û–¢?\n\n';
    message += 'üìÖ –î–∞—Ç–∞: ' + formatDateForDisplay(record.date) + '\n';
    message += 'üë§ –ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: ' + (record.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫') + '\n';
    message += 'üë®‚Äçüíº –°–æ—Ç—Ä—É–¥–Ω–∏–∫: ' + record.employee + '\n';
    message += '‚è±Ô∏è –í—Ä–µ–º—è: ' + record.time + ' –º–∏–Ω\n\n';
    message += '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!';
    
    if (confirm(message)) {
        eIsotResults = eIsotResults.filter(function(r) { return r.id !== id; });
        saveData();
        renderEIsot();
        addToFullHistory('–ï–ò–°–û–¢ —É–¥–∞–ª–µ–Ω–∞: ' + record.employee);
        showNotification('üóëÔ∏è –ï–ò–°–û–¢ —É–¥–∞–ª–µ–Ω–∞', 'info');
    }
}

function addPrombez() {
    var date = document.getElementById('prombezDate').value;
    var desc = document.getElementById('prombezDescription').value.trim();
    
    if (!date || !desc) {
        showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
        return;
    }
    
    prombezResults.push({
        id: Date.now(),
        date: date,
        instructor: currentUser,
        description: desc
    });
    
    saveData();
    closeModal('prombezModal');
    renderPrombez();
    addToFullHistory('–ü—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞');
    showNotification('‚úÖ –ü—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
}

function renderPrombez() {
    var html = '';
    prombezResults.sort(function(a, b) {
        return new Date(a.date) - new Date(b.date);
    }).forEach(function(r) {
        html += '<tr>';
        html += '<td>' + formatDateForDisplay(r.date) + '</td>';
        html += '<td>' + (r.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫') + '</td>';
        html += '<td>' + r.description + '</td>';
        html += '<td><button class="btn btn-danger btn-sm" onclick="deletePrombez(' + r.id + ')"><i class="fas fa-trash"></i></button></td>';
        html += '</tr>';
    });
    document.getElementById('prombezTable').innerHTML = html || '<tr><td colspan="4">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
}

function deletePrombez(id) {
    var record = prombezResults.find(function(r) { return r.id === id; });
    if (!record) return;
    
    if (record.instructor !== currentUser && currentUser !== 'oka') {
        showNotification('‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }
    
    var message = '‚ö†Ô∏è –í–´ –£–í–ï–†–ï–ù–´ –ß–¢–û –•–û–¢–ò–¢–ï –£–î–ê–õ–ò–¢–¨ –≠–¢–£ –ó–ê–ü–ò–°–¨ –ü–†–û–ú–ë–ï–ó?\n\n';
    message += 'üìÖ –î–∞—Ç–∞: ' + formatDateForDisplay(record.date) + '\n';
    message += 'üë§ –ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: ' + (record.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫') + '\n';
    message += 'üìù –û–ø–∏—Å–∞–Ω–∏–µ: ' + record.description + '\n\n';
    message += '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!';
    
    if (confirm(message)) {
        prombezResults = prombezResults.filter(function(r) { return r.id !== id; });
        saveData();
        renderPrombez();
        addToFullHistory('–ü—Ä–æ–º–±–µ–∑ –∑–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
        showNotification('üóëÔ∏è –ü—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞', 'info');
    }
}

function addNDTesting() {
    var date = document.getElementById('ndTestDate').value;
    var type = document.getElementById('ndTestType').value;
    var desc = document.getElementById('ndTestDesc').value.trim();
    
    if (!date || !type || !desc) {
        showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
        return;
    }
    
    ndTestingResults.push({
        id: Date.now(),
        date: date,
        type: type,
        instructor: currentUser,
        description: desc
    });
    
    saveData();
    closeModal('ndTestingModal');
    renderNDTesting();
    addToFullHistory('–ù–î —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ' + type);
    showNotification('‚úÖ –ù–î —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
}

function renderNDTesting() {
    var html = '';
    ndTestingResults.sort(function(a, b) {
        return new Date(a.date) - new Date(b.date);
    }).forEach(function(r) {
        html += '<tr>';
        html += '<td>' + formatDateForDisplay(r.date) + '</td>';
        html += '<td>' + r.type + '</td>';
        html += '<td>' + (r.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫') + '</td>';
        html += '<td>' + r.description + '</td>';
        html += '<td><button class="btn btn-danger btn-sm" onclick="deleteNDTesting(' + r.id + ')"><i class="fas fa-trash"></i></button></td>';
        html += '</tr>';
    });
    document.getElementById('ndTestingTable').innerHTML = html || '<tr><td colspan="5">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
}

function deleteNDTesting(id) {
    var record = ndTestingResults.find(function(r) { return r.id === id; });
    if (!record) return;
    
    if (record.instructor !== currentUser && currentUser !== 'oka') {
        showNotification('‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }
    
    var message = '‚ö†Ô∏è –í–´ –£–í–ï–†–ï–ù–´ –ß–¢–û –•–û–¢–ò–¢–ï –£–î–ê–õ–ò–¢–¨ –≠–¢–£ –ó–ê–ü–ò–°–¨ –ù–î –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø?\n\n';
    message += 'üìÖ –î–∞—Ç–∞: ' + formatDateForDisplay(record.date) + '\n';
    message += 'üß™ –¢–∏–ø: ' + record.type + '\n';
    message += 'üë§ –ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: ' + (record.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫') + '\n';
    message += 'üìù –û–ø–∏—Å–∞–Ω–∏–µ: ' + record.description + '\n\n';
    message += '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!';
    
    if (confirm(message)) {
        ndTestingResults = ndTestingResults.filter(function(r) { return r.id !== id; });
        saveData();
        renderNDTesting();
        addToFullHistory('–ù–î —Ç–µ—Å—Ç —É–¥–∞–ª—ë–Ω: ' + record.type);
        showNotification('üóëÔ∏è –ù–î —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'info');
    }
}

// ============= –°–¢–ê–¢–ò–°–¢–ò–ö–ê =============
function updateStats() {
    var total = tasks.length;
    var completed = tasks.filter(function(t) { return t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'; });
    var inProgress = tasks.filter(function(t) { return t.status === '–ù–∞—á–∞—Ç–æ'; });
    var totalMinutes = tasks.reduce(function(sum, t) { return sum + (t.actualMinutes || 0); }, 0);
    var asanbek = completed.filter(function(t) { return t.assignedTo === 'asanbek'; }).length;
    var akylbek = completed.filter(function(t) { return t.assignedTo === 'akylbek'; }).length;
    
    document.getElementById('totalTasks').textContent = total;
    document.getElementById('completedTasks').textContent = completed.length;
    document.getElementById('inProgressTasks').textContent = inProgress.length;
    document.getElementById('totalHours').textContent = minutesToTime(totalMinutes);
    document.getElementById('statAsanbek').textContent = asanbek;
    document.getElementById('statAkylbek').textContent = akylbek;
}

// ============= –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê =============
function showAdvancedAnalytics() {
    var period = document.getElementById('analyticsPeriod').value;
    var taskTypeFilter = document.getElementById('analyticsTaskType').value;
    
    var filteredTasks = tasks.filter(function(t) { 
        return (taskTypeFilter === 'all' || t.taskType === taskTypeFilter) && t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
    });
    
    var html = '';
    
    var instructionTasks = filteredTasks.filter(function(t) { return t.taskType === 'instruction'; }).length;
    var routineTasks = filteredTasks.filter(function(t) { return t.taskType === 'routine'; }).length;
    var totalTasks = filteredTasks.length;
    
    html += '<div class="analytics-section">';
    html += '<h3>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>';
    html += '<div class="analytics-grid">';
    html += '<div class="analytics-card"><h4>–í—Å–µ–≥–æ –∑–∞–¥–∞—á</h4><div class="analytics-value">' + totalTasks + '</div></div>';
    html += '<div class="analytics-card"><h4>–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏</h4><div class="analytics-value">' + instructionTasks + '</div></div>';
    html += '<div class="analytics-card"><h4>–†—É—Ç–∏–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h4><div class="analytics-value">' + routineTasks + '</div></div>';
    html += '<div class="analytics-card"><h4>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ</h4><div class="analytics-value">' + (totalTasks > 0 ? Math.round(instructionTasks/totalTasks*100) : 0) + '% / ' + (totalTasks > 0 ? Math.round(routineTasks/totalTasks*100) : 0) + '%</div></div>';
    html += '</div></div>';
    
    var totalMinutes = filteredTasks.reduce(function(sum, t) { return sum + (t.actualMinutes || 0); }, 0);
    var avgMinutes = totalTasks > 0 ? Math.round(totalMinutes / totalTasks) : 0;
    
    html += '<div class="analytics-section">';
    html += '<h3>‚è±Ô∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>';
    html += '<div class="analytics-grid">';
    html += '<div class="analytics-card"><h4>–û–±—â–µ–µ –≤—Ä–µ–º—è</h4><div class="analytics-value">' + minutesToTime(totalMinutes) + '</div></div>';
    html += '<div class="analytics-card"><h4>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∑–∞–¥–∞—á—É</h4><div class="analytics-value">' + minutesToTime(avgMinutes) + '</div></div>';
    html += '<div class="analytics-card"><h4>–í—Ä–µ–º—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π</h4><div class="analytics-value">' + minutesToTime(filteredTasks.filter(t => t.taskType === 'instruction').reduce((sum, t) => sum + (t.actualMinutes || 0), 0)) + '</div></div>';
    html += '<div class="analytics-card"><h4>–í—Ä–µ–º—è —Ä—É—Ç–∏–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</h4><div class="analytics-value">' + minutesToTime(filteredTasks.filter(t => t.taskType === 'routine').reduce((sum, t) => sum + (t.actualMinutes || 0), 0)) + '</div></div>';
    html += '</div></div>';
    
    var asanbekTasks = filteredTasks.filter(function(t) { return t.assignedTo === 'asanbek'; });
    var akylbekTasks = filteredTasks.filter(function(t) { return t.assignedTo === 'akylbek'; });
    
    html += '<div class="analytics-section">';
    html += '<h3>üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h3>';
    html += '<div class="analytics-grid">';
    html += '<div class="analytics-card"><h4>–ê—Å–∞–Ω–±–µ–∫: –∑–∞–¥–∞—á–∏</h4><div class="analytics-value">' + asanbekTasks.length + '</div></div>';
    html += '<div class="analytics-card"><h4>–ê—Å–∞–Ω–±–µ–∫: –≤—Ä–µ–º—è</h4><div class="analytics-value">' + minutesToTime(asanbekTasks.reduce((sum, t) => sum + (t.actualMinutes || 0), 0)) + '</div></div>';
    html += '<div class="analytics-card"><h4>–ê–∫—ã–ª–±–µ–∫: –∑–∞–¥–∞—á–∏</h4><div class="analytics-value">' + akylbekTasks.length + '</div></div>';
    html += '<div class="analytics-card"><h4>–ê–∫—ã–ª–±–µ–∫: –≤—Ä–µ–º—è</h4><div class="analytics-value">' + minutesToTime(akylbekTasks.reduce((sum, t) => sum + (t.actualMinutes || 0), 0)) + '</div></div>';
    html += '</div></div>';
    
    document.getElementById('advancedAnalyticsContent').innerHTML = html;
    renderAdvancedCharts(filteredTasks);
}

function renderAdvancedCharts(filteredTasks) {
    renderTaskTypeChart(filteredTasks);
    renderEfficiencyChart(filteredTasks);
    renderInstructorChart();
}

function renderTaskTypeChart(filteredTasks) {
    var ctx = document.getElementById('taskTypeChart');
    if (!ctx) return;
    
    var instructionTasks = filteredTasks.filter(function(t) { return t.taskType === 'instruction'; }).length;
    var routineTasks = filteredTasks.filter(function(t) { return t.taskType === 'routine'; }).length;
    
    if (taskTypeChartInstance) taskTypeChartInstance.destroy();
    
    taskTypeChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏', '–†—É—Ç–∏–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏'],
            datasets: [{
                data: [instructionTasks, routineTasks],
                backgroundColor: ['#60a5fa', '#8b5cf6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#e6eef8' }
                }
            }
        }
    });
}

function renderEfficiencyChart(filteredTasks) {
    var ctx = document.getElementById('efficiencyChart');
    if (!ctx) return;
    
    var today = new Date();
    var weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay() + 1);
    
    var labels = [];
    var instructionData = [];
    var routineData = [];
    
    for (var i = 0; i < 7; i++) {
        var d = new Date(weekStart);
        d.setDate(d.getDate() + i);
        var ds = d.toISOString().split('T')[0];
        labels.push(formatDateForDisplay(ds).substring(0, 5));
        
        var dayTasks = filteredTasks.filter(function(t) { return t.dateEnd === ds; });
        var instructionCount = dayTasks.filter(function(t) { return t.taskType === 'instruction'; }).length;
        var routineCount = dayTasks.filter(function(t) { return t.taskType === 'routine'; }).length;
        
        instructionData.push(instructionCount);
        routineData.push(routineCount);
    }
    
    if (efficiencyChartInstance) efficiencyChartInstance.destroy();
    
    efficiencyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏',
                    data: instructionData,
                    backgroundColor: '#60a5fa'
                },
                {
                    label: '–†—É—Ç–∏–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏',
                    data: routineData,
                    backgroundColor: '#8b5cf6'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#e6eef8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#e6eef8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: '#e6eef8' }
                }
            }
        }
    });
}

// ============= –î–ê–®–ë–û–†–î =============
function renderDashboard() {
    updateStats();
    renderKPI();
    renderStatusChart();
    renderCategoryChart();
    renderWeeklyTrendChart();
}

function renderKPI() {
    var total = tasks.length;
    var completed = tasks.filter(function(t) { return t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'; });
    var completionRate = total > 0 ? (completed.length / total * 100).toFixed(1) : 0;
    
    var totalMinutes = tasks.reduce(function(s, t) { return s + (t.actualMinutes || 0); }, 0);
    var avgMinutes = total > 0 ? Math.round(totalMinutes / total) : 0;
    
    var thisWeek = tasks.filter(function(t) {
        var taskDate = new Date(t.dateStart);
        var today = new Date();
        var weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay() + 1);
        return taskDate >= weekStart && taskDate <= today;
    }).length;
    
    var html = '';
    html += '<div class="kpi-item">';
    html += '<div class="kpi-value">' + completionRate + '%</div>';
    html += '<div class="kpi-label">–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>';
    html += '<div class="progress-bar"><div class="progress-fill" style="width:' + completionRate + '%"></div></div>';
    html += '</div>';
    
    html += '<div class="kpi-item">';
    html += '<div class="kpi-value">' + minutesToTime(avgMinutes) + '</div>';
    html += '<div class="kpi-label">–°—Ä–µ–¥–Ω. –≤—Ä–µ–º—è</div>';
    html += '</div>';
    
    html += '<div class="kpi-item">';
    html += '<div class="kpi-value">' + thisWeek + '</div>';
    html += '<div class="kpi-label">–ó–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é</div>';
    html += '</div>';
    
    document.getElementById('kpiGrid').innerHTML = html;
}

function renderStatusChart() {
    var ctx = document.getElementById('statusChart');
    if (!ctx) return;
    
    var notStarted = tasks.filter(function(t) { return t.status === '–û–∂–∏–¥–∞–Ω–∏–µ'; }).length;
    var inProgress = tasks.filter(function(t) { return t.status === '–ù–∞—á–∞—Ç–æ'; }).length;
    var completed = tasks.filter(function(t) { return t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'; }).length;
    
    if (statusChartInstance) statusChartInstance.destroy();
    
    statusChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['–û–∂–∏–¥–∞–Ω–∏–µ', '–ù–∞—á–∞—Ç–æ', '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'],
            datasets: [{
                data: [notStarted, inProgress, completed],
                backgroundColor: ['#fcd34d', '#93c5fd', '#86efac'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#e6eef8' }
                }
            }
        }
    });
}

function renderCategoryChart() {
    var ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    var catCounts = {};
    tasks.forEach(function(t) {
        catCounts[t.category] = (catCounts[t.category] || 0) + 1;
    });
    
    var labels = Object.keys(catCounts);
    var data = Object.values(catCounts);
    
    if (categoryChartInstance) categoryChartInstance.destroy();
    
    categoryChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: ['#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8', '#1e40af'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#e6eef8' }
                }
            }
        }
    });
}

function renderWeeklyTrendChart() {
    var ctx = document.getElementById('weeklyTrendChart');
    if (!ctx) return;
    
    var today = new Date();
    var weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay() + 1);
    
    var labels = [];
    var data = [];
    
    for (var i = 0; i < 7; i++) {
        var d = new Date(weekStart);
        d.setDate(d.getDate() + i);
        var ds = d.toISOString().split('T')[0];
        labels.push(formatDateForDisplay(ds).substring(0, 5));
        
        var count = tasks.filter(function(t) { 
            return t.dateEnd === ds && t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
        }).length;
        data.push(count);
    }
    
    if (weeklyTrendChartInstance) weeklyTrendChartInstance.destroy();
    
    weeklyTrendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
                data: data,
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#e6eef8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#e6eef8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: '#e6eef8' }
                }
            }
        }
    });
}

function renderAnalytics() {
    showAdvancedAnalytics();
    renderInstructorChart();
}

function renderInstructorChart() {
    var ctx = document.getElementById('instructorChart');
    if (!ctx) return;
    
    var asanbek = tasks.filter(function(t) { return t.assignedTo === 'asanbek' && t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'; }).length;
    var akylbek = tasks.filter(function(t) { return t.assignedTo === 'akylbek' && t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'; }).length;
    
    var asanbekMinutes = tasks.filter(function(t) { return t.assignedTo === 'asanbek'; }).reduce(function(s, t) { return s + (t.actualMinutes || 0); }, 0);
    var akylbekMinutes = tasks.filter(function(t) { return t.assignedTo === 'akylbek'; }).reduce(function(s, t) { return s + (t.actualMinutes || 0); }, 0);
    
    if (instructorChartInstance) instructorChartInstance.destroy();
    
    instructorChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['–ê—Å–∞–Ω–±–µ–∫', '–ê–∫—ã–ª–±–µ–∫'],
            datasets: [
                {
                    label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á',
                    data: [asanbek, akylbek],
                    backgroundColor: '#60a5fa'
                },
                {
                    label: '–ß–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã (–¥–µ—Å—è—Ç–∏—á–Ω.)',
                    data: [minutesToDecimalHours(asanbekMinutes), minutesToDecimalHours(akylbekMinutes)],
                    backgroundColor: '#10b981'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#e6eef8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#e6eef8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: '#e6eef8' }
                }
            }
        }
    });
}

// ============= –ò–°–¢–û–†–ò–Ø =============
function addToFullHistory(action) {
    var today = getTodayDate();
    var time = new Date().toLocaleTimeString('ru-RU');
    fullHistory.push({
        date: today,
        time: time,
        action: action,
        user: currentUser
    });
    saveData();
}

function renderHistory() {
    var filter = document.getElementById('historyFilter').value;
    var filtered = fullHistory.filter(function(h) {
        return !filter || h.user === filter;
    });
    
    var byDate = {};
    filtered.forEach(function(h) {
        if (!byDate[h.date]) byDate[h.date] = [];
        byDate[h.date].push(h);
    });
    
    var dates = Object.keys(byDate).sort().reverse();
    var html = '';
    dates.forEach(function(date) {
        var events = byDate[date];
        html += '<div class="history-day"><div class="history-day-header" onclick="toggleHistory(this)"><span>üìÖ ' + formatDateForDisplay(date) + ' (' + events.length + ')</span><span>‚ñº</span></div><div class="history-day-content">';
        events.forEach(function(h) {
            html += '<div class="history-item"><strong>‚è∞ ' + h.time + '</strong> - ' + h.action + '<br><small>üë§ ' + (h.user === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : h.user === 'akylbek' ? '–ê–∫—ã–ª–±–µ–∫' : '–û–∫–∞') + '</small></div>';
        });
        html += '</div></div>';
    });
    
    document.getElementById('historyContainer').innerHTML = html || '<p style="text-align:center; padding:20px; color:var(--text-secondary)">üì≠ –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
}

function toggleHistory(el) {
    el.nextElementSibling.classList.toggle('show');
}

// ============= –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò =============
function renderMainCategoriesManager() {
    var html = '<div style="padding: 15px; background: rgba(15, 23, 36, 0.7); border-radius: 8px; border: 1px solid var(--border)">';
    
    var catKeys = Object.keys(categories);
    catKeys.forEach(function(cat, index) {
        html += '<div class="category-item">';
        html += '<input type="text" value="' + cat + '" id="maincat_' + index + '">';
        html += '<button class="btn btn-warning btn-sm" onclick="renameCategory(' + index + ', \'' + cat + '\')">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>';
        html += '<button class="btn btn-danger btn-sm" onclick="deleteCategory(\'' + cat + '\')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>';
        html += '</div>';
    });
    
    html += '</div>';
    document.getElementById('mainCategoriesManager').innerHTML = html;
}

function addNewCategory() {
    var newCat = document.getElementById('newCategoryName').value.trim();
    if (!newCat) {
        showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!', 'error');
        return;
    }
    
    if (categories[newCat]) {
        showNotification('‚ùå –¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'error');
        return;
    }
    
    categories[newCat] = ['‚ûï –î—Ä—É–≥–æ–µ'];
    document.getElementById('newCategoryName').value = '';
    saveData();
    populateCategories();
    renderMainCategoriesManager();
    renderCategoriesManager();
    showNotification('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!', 'success');
    addToFullHistory('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ' + newCat);
}

function renameCategory(index, oldName) {
    var newName = document.getElementById('maincat_' + index).value.trim();
    if (!newName || newName === oldName) return;
    
    if (categories[newName]) {
        showNotification('‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'error');
        return;
    }
    
    categories[newName] = categories[oldName];
    delete categories[oldName];
    
    tasks.forEach(function(task) {
        if (task.category === oldName) {
            task.category = newName;
        }
    });
    
    saveData();
    populateCategories();
    renderMainCategoriesManager();
    renderCategoriesManager();
    showTasks();
    showNotification('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞!', 'success');
    addToFullHistory('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞: "' + oldName + '" ‚Üí "' + newName + '"');
}

function deleteCategory(catName) {
    var tasksInCategory = tasks.filter(function(t) { return t.category === catName; }).length;
    
    var message = '‚ö†Ô∏è –£–î–ê–õ–ò–¢–¨ –ö–ê–¢–ï–ì–û–†–ò–Æ "' + catName + '"?\n\n';
    if (tasksInCategory > 0) {
        message += '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ' + tasksInCategory + ' –∑–∞–¥–∞—á(–∏)!\n';
        message += '–í—Å–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —Ç–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω—ã!\n\n';
    }
    message += '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!';
    
    if (confirm(message)) {
        delete categories[catName];
        tasks = tasks.filter(function(t) { return t.category !== catName; });
        
        saveData();
        populateCategories();
        renderMainCategoriesManager();
        renderCategoriesManager();
        showTasks();
        showNotification('üóëÔ∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞!', 'info');
        addToFullHistory('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞: ' + catName + ' (' + tasksInCategory + ' –∑–∞–¥–∞—á)');
    }
}

function renderCategoriesManager() {
    var html = '';
    for (var cat in categories) {
        html += '<div style="margin-bottom: 15px; padding: 15px; background: rgba(15, 23, 36, 0.7); border-radius: 8px; border: 1px solid var(--border)">';
        html += '<strong style="cursor: pointer; color: var(--accent); font-size: 16px" onclick="toggleCategoryEdit(\'' + cat + '\')">üìÅ ' + cat + '</strong>';
        html += '<div id="cat_' + cat + '" style="display: none; margin-top: 15px;">';
        
        for (var i = 0; i < categories[cat].length; i++) {
            var sub = categories[cat][i];
            if (sub === '‚ûï –î—Ä—É–≥–æ–µ') continue;
            html += '<div class="category-item">';
            html += '<input type="text" value="' + sub + '" id="sub_' + cat + '_' + i + '">';
            html += '<button class="btn btn-danger btn-sm" onclick="removeSubcategory(\'' + cat + '\', ' + i + ')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>';
            html += '</div>';
        }
        
        html += '<div class="category-item">';
        html += '<input type="text" id="new_' + cat + '" placeholder="–ù–æ–≤–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è">';
        html += '<button class="btn btn-success btn-sm" onclick="addSubcategory(\'' + cat + '\')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>';
        html += '</div>';
        html += '<button class="btn btn-sm" onclick="saveCategoryChanges(\'' + cat + '\')" style="margin-top: 10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>';
        html += '</div>';
        html += '</div>';
    }
    document.getElementById('categoriesManager').innerHTML = html;
}

function renderNdTestTypesManager() {
    var html = '<div style="padding: 15px; background: rgba(15, 23, 36, 0.7); border-radius: 8px; border: 1px solid var(--border)">';
    
    ndTestTypes.forEach(function(type, index) {
        html += '<div class="category-item">';
        html += '<input type="text" value="' + type + '" id="ndtype_' + index + '">';
        html += '<button class="btn btn-danger btn-sm" onclick="removeNdTestType(' + index + ')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>';
        html += '</div>';
    });
    
    html += '<div class="category-item">';
    html += '<input type="text" id="new_ndtype" placeholder="–ù–æ–≤—ã–π —Ç–∏–ø —Ç–µ—Å—Ç–∞">';
    html += '<button class="btn btn-success btn-sm" onclick="addNdTestType()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>';
    html += '</div>';
    html += '<button class="btn btn-sm" onclick="saveNdTestTypes()" style="margin-top: 10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>';
    html += '</div>';
    
    document.getElementById('ndTestTypesManager').innerHTML = html;
}

function addNdTestType() {
    var newVal = document.getElementById('new_ndtype').value.trim();
    if (newVal) {
        ndTestTypes.push(newVal);
        document.getElementById('new_ndtype').value = '';
        renderNdTestTypesManager();
    }
}

function removeNdTestType(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–∏–ø —Ç–µ—Å—Ç–∞?')) {
        ndTestTypes.splice(index, 1);
        renderNdTestTypesManager();
    }
}

function saveNdTestTypes() {
    var newTypes = [];
    for (var i = 0; i < ndTestTypes.length; i++) {
        var val = document.getElementById('ndtype_' + i).value.trim();
        if (val) newTypes.push(val);
    }
    ndTestTypes = newTypes;
    saveData();
    showNotification('üíæ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
}

function toggleCategoryEdit(cat) {
    var el = document.getElementById('cat_' + cat);
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function addSubcategory(cat) {
    var newVal = document.getElementById('new_' + cat).value.trim();
    if (newVal) {
        categories[cat][categories[cat].length - 1] = newVal;
        categories[cat].push('‚ûï –î—Ä—É–≥–æ–µ');
        document.getElementById('new_' + cat).value = '';
        renderCategoriesManager();
    }
}

function removeSubcategory(cat, index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
        categories[cat].splice(index, 1);
        renderCategoriesManager();
    }
}

function saveCategoryChanges(cat) {
    var newCat = [];
    for (var i = 0; i < categories[cat].length; i++) {
        if (categories[cat][i] === '‚ûï –î—Ä—É–≥–æ–µ') {
            newCat.push('‚ûï –î—Ä—É–≥–æ–µ');
            continue;
        }
        var val = document.getElementById('sub_' + cat + '_' + i).value.trim();
        if (val) newCat.push(val);
    }
    categories[cat] = newCat;
    saveData();
    populateCategories();
    showNotification('üíæ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
}

// ============= –≠–ö–°–ü–û–†–¢/–ò–ú–ü–û–†–¢ =============
function doExport() {
    try {
        console.log('üìä –ù–∞—á–∏–Ω–∞—é —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel...');
        
        if (typeof XLSX === 'undefined') {
            showNotification('‚ùå –û–®–ò–ë–ö–ê: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'error');
            return;
        }
        
        console.log('‚úÖ XLSX –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∞–π–¥–µ–Ω–∞');
        
        var exportData = tasks.map(function(t) {
            var statusIcon = t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' ? '‚úÖ' : 
                           t.status === '–ù–∞—á–∞—Ç–æ' ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            
            var createdDate = t.createdAt ? new Date(t.createdAt).toLocaleString('ru-RU') : '';
            var startedDate = t.startedAt ? new Date(t.startedAt).toLocaleString('ru-RU') : '';
            var completedDate = t.completedAt ? new Date(t.completedAt).toLocaleString('ru-RU') : '';
            
            return {
                'üìÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞': formatDateForDisplay(t.dateStart),
                'üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è': t.dateEnd ? formatDateForDisplay(t.dateEnd) : '',
                'üïê –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞': t.timeStart || '',
                'üïê –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è': t.timeEnd || '',
                '‚è±Ô∏è –ó–∞—Ç—Ä–∞—á–µ–Ω–æ': t.actualMinutes ? minutesToTime(t.actualMinutes) : '',
                'üìã –¢–∏–ø': t.taskType === 'instruction' ? '–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂' : '–†—É—Ç–∏–Ω–Ω–∞—è',
                'üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è': t.category,
                'üìÇ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è': t.subcategory,
                'üìù –ù–∞–∑–≤–∞–Ω–∏–µ': t.name,
                'üë§ –ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä': t.assignedTo === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫',
                'üìä –°—Ç–∞—Ç—É—Å': statusIcon + ' ' + t.status,
                'üÜï –°–æ–∑–¥–∞–Ω–æ': createdDate,
                '‚ñ∂Ô∏è –ù–∞—á–∞—Ç–æ': startedDate,
                '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ': completedDate
            };
        });
        
        console.log('üìã –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', exportData.length);
        
        var wb = XLSX.utils.book_new();
        
        var ws = XLSX.utils.json_to_sheet(exportData);
        
        ws['!cols'] = [
            { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
            { wch: 12 }, { wch: 25 }, { wch: 25 }, { wch: 40 }, { wch: 12 },
            { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, '–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏');
        
        var stats = [
            { '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': '–í—Å–µ–≥–æ –∑–∞–¥–∞—á', '–ó–Ω–∞—á–µ–Ω–∏–µ': tasks.length },
            { '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', '–ó–Ω–∞—á–µ–Ω–∏–µ': tasks.filter(function(t) { return t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'; }).length },
            { '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ', '–ó–Ω–∞—á–µ–Ω–∏–µ': tasks.filter(function(t) { return t.status === '–ù–∞—á–∞—Ç–æ'; }).length },
            { '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': '–û–∂–∏–¥–∞–Ω–∏–µ', '–ó–Ω–∞—á–µ–Ω–∏–µ': tasks.filter(function(t) { return t.status === '–û–∂–∏–¥–∞–Ω–∏–µ'; }).length },
            { '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': '–í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏', '–ó–Ω–∞—á–µ–Ω–∏–µ': minutesToTime(tasks.reduce(function(s, t) { return s + (t.actualMinutes || 0); }, 0)) },
            { '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': '–ê—Å–∞–Ω–±–µ–∫ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)', '–ó–Ω–∞—á–µ–Ω–∏–µ': tasks.filter(function(t) { return t.assignedTo === 'asanbek' && t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'; }).length },
            { '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': '–ê–∫—ã–ª–±–µ–∫ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)', '–ó–Ω–∞—á–µ–Ω–∏–µ': tasks.filter(function(t) { return t.assignedTo === 'akylbek' && t.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'; }).length }
        ];
        var wsStats = XLSX.utils.json_to_sheet(stats);
        wsStats['!cols'] = [{ wch: 25 }, { wch: 20 }];
        XLSX.utils.book_append_sheet(wb, wsStats, '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');
        
        if (eIsotResults.length > 0) {
            var eIsotData = eIsotResults.map(function(r) {
                return {
                    '–î–∞—Ç–∞': formatDateForDisplay(r.date),
                    '–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä': r.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫',
                    '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': r.employee,
                    '–í—Ä–µ–º—è (–º–∏–Ω)': r.time
                };
            });
            var wsEisot = XLSX.utils.json_to_sheet(eIsotData);
            XLSX.utils.book_append_sheet(wb, wsEisot, '–ï–ò–°–û–¢');
        }
        
        if (prombezResults.length > 0) {
            var prombezData = prombezResults.map(function(r) {
                return {
                    '–î–∞—Ç–∞': formatDateForDisplay(r.date),
                    '–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä': r.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫',
                    '–û–ø–∏—Å–∞–Ω–∏–µ': r.description
                };
            });
            var wsPrombez = XLSX.utils.json_to_sheet(prombezData);
            XLSX.utils.book_append_sheet(wb, wsPrombez, '–ü—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å');
        }
        
        if (ndTestingResults.length > 0) {
            var ndData = ndTestingResults.map(function(r) {
                return {
                    '–î–∞—Ç–∞': formatDateForDisplay(r.date),
                    '–¢–∏–ø': r.type,
                    '–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä': r.instructor === 'asanbek' ? '–ê—Å–∞–Ω–±–µ–∫' : '–ê–∫—ã–ª–±–µ–∫',
                    '–û–ø–∏—Å–∞–Ω–∏–µ': r.description
                };
            });
            var wsNd = XLSX.utils.json_to_sheet(ndData);
            XLSX.utils.book_append_sheet(wb, wsNd, '–ù–î —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ');
        }
        
        var filename = '–†–µ–µ—Å—Ç—Ä_–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π_' + new Date().toISOString().split('T')[0] + '.xlsx';
        XLSX.writeFile(wb, filename);
        
        console.log('‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω:', filename);
        addToFullHistory('üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel: ' + tasks.length + ' –∑–∞–ø–∏—Å–µ–π');
        showNotification('‚úÖ –≠–ö–°–ü–û–†–¢ –í–´–ü–û–õ–ù–ï–ù! –§–∞–π–ª: ' + filename, 'success');
        
    } catch(error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        showNotification('‚ùå –û–®–ò–ë–ö–ê –≠–ö–°–ü–û–†–¢–ê: ' + error.message, 'error');
    }
}

function doExportJSON() {
    try {
        var data = {
            tasks: tasks,
            eIsot: eIsotResults,
            prombez: prombezResults,
            nd: ndTestingResults,
            history: fullHistory,
            categories: categories,
            ndTestTypes: ndTestTypes,
            exportDate: new Date().toISOString()
        };
        var json = JSON.stringify(data, null, 2);
        var blob = new Blob([json], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'backup_' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
        addToFullHistory('üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON');
        showNotification('‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON –≤—ã–ø–æ–ª–Ω–µ–Ω!', 'success');
    } catch(error) {
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ JSON: ' + error.message, 'error');
    }
}

function importFromFile() {
    var file = document.getElementById('importFile').files[0];
    if (!file) {
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
        return;
    }
    
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = JSON.parse(e.target.result);
            tasks = data.tasks || [];
            eIsotResults = data.eIsot || [];
            prombezResults = data.prombez || [];
            ndTestingResults = data.nd || [];
            fullHistory = data.history || [];
            categories = data.categories || categories;
            ndTestTypes = data.ndTestTypes || ndTestTypes;
            saveData();
            populateCategories();
            showTasks();
            updateStats();
            updateTaskNameSuggestions();
            showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
            addToFullHistory('üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö');
        } catch(e) {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö: ' + e.message, 'error');
        }
    };
    reader.readAsText(file);
}

// ============= GOOGLE SHEETS –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø) =============
async function syncToCloud() {
    try {
        console.log('üîÑ –ù–∞—á–∏–Ω–∞—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å Google Sheets...');
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ —Ç–∏–ø–∞–º
        const dataToSync = {
            dataType: 'fullState',
            data: {
                tasks: tasks,
                eIsotResults: eIsotResults,
                prombezResults: prombezResults,
                ndTestingResults: ndTestingResults,
                fullHistory: fullHistory,
                categories: categories,
                ndTestTypes: ndTestTypes,
                lastSync: new Date().toISOString(),
                syncedBy: currentUser
            },
            user: currentUser,
            action: 'save'
        };
        
        console.log('üìä –û—Ç–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ:', {
            tasks: tasks.length,
            eIsotResults: eIsotResults.length,
            prombezResults: prombezResults.length,
            ndTestingResults: ndTestingResults.length,
            history: fullHistory.length,
            categories: Object.keys(categories).length
        });
        
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dataToSync)
        });
        
        const result = await response.json();
        console.log('üì® –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
        
        if (result.status === "success") {
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å Google Sheets');
            updateSyncStatus('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ', 'success');
            return true;
        } else {
            throw new Error(result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
        updateSyncStatus('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
        return false;
    }
}

async function syncFromCloud() {
    try {
        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets...');
        
        const url = GOOGLE_SCRIPT_URL + '?action=get_all&t=' + Date.now();
        const response = await fetch(url);
        const result = await response.json();
        
        console.log('üì• –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', result);
        
        if (result.status === "success" && result.data) {
            const cloudData = result.data;
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Å–ª–∏—è–Ω–∏—è, –∞ –Ω–µ –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã
            
            // –î–ª—è –∑–∞–¥–∞—á: –æ–±—ä–µ–¥–∏–Ω—è–µ–º –ø–æ ID
            if (cloudData.tasks && cloudData.tasks.length > 0) {
                const taskMap = new Map();
                
                // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
                tasks.forEach(task => taskMap.set(task.id, task));
                
                // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞—á–Ω—ã–µ –∑–∞–¥–∞—á–∏
                cloudData.tasks.forEach(cloudTask => {
                    if (!taskMap.has(cloudTask.id)) {
                        taskMap.set(cloudTask.id, cloudTask);
                    }
                });
                
                tasks = Array.from(taskMap.values());
            }
            
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–ª–∞—á–Ω—ã–µ –≤–µ—Ä—Å–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (cloudData.eIsotResults && cloudData.eIsotResults.length > 0) {
                eIsotResults = cloudData.eIsotResults;
            }
            if (cloudData.prombezResults && cloudData.prombezResults.length > 0) {
                prombezResults = cloudData.prombezResults;
            }
            if (cloudData.ndTestingResults && cloudData.ndTestingResults.length > 0) {
                ndTestingResults = cloudData.ndTestingResults;
            }
            if (cloudData.fullHistory && cloudData.fullHistory.length > 0) {
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
                const historyMap = new Map();
                fullHistory.forEach(item => {
                    const key = item.date + '-' + item.time + '-' + item.action;
                    historyMap.set(key, item);
                });
                cloudData.fullHistory.forEach(item => {
                    const key = item.date + '-' + item.time + '-' + item.action;
                    historyMap.set(key, item);
                });
                fullHistory = Array.from(historyMap.values())
                    .sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
            }
            if (cloudData.categories && Object.keys(cloudData.categories).length > 0) {
                categories = { ...categories, ...cloudData.categories };
            }
            if (cloudData.ndTestTypes && cloudData.ndTestTypes.length > 0) {
                ndTestTypes = [...new Set([...ndTestTypes, ...cloudData.ndTestTypes])];
            }
            
            saveData();
            
            showTasks();
            updateStats();
            updateTaskNameSuggestions();
            
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
            updateSyncStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞', 'success');
            
            return true;
        } else if (result.status === "no_data") {
            console.log('üì≠ –í –æ–±–ª–∞–∫–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
            updateSyncStatus('üì≠ –í –æ–±–ª–∞–∫–µ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', 'info');
            return false;
        } else {
            throw new Error(result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        updateSyncStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
        return false;
    }
}

function updateSyncStatus(message, type) {
    const statusElement = document.getElementById('syncStatus');
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.style.display = 'block';
        statusElement.style.background = type === 'success' ? 'rgba(16, 185, 129, 0.2)' : 
                                       type === 'error' ? 'rgba(239, 68, 68, 0.2)' : 
                                       'rgba(59, 130, 246, 0.2)';
        statusElement.style.color = type === 'success' ? '#10b981' : 
                                   type === 'error' ? '#ef4444' : 
                                   '#3b82f6';
        statusElement.style.border = type === 'success' ? '1px solid #10b981' : 
                                    type === 'error' ? '1px solid #ef4444' : 
                                    '1px solid #3b82f6';
    }
}

// ============= –í–ö–õ–ê–î–ö–ò =============
function openTab(evt, tabName) {
    var tabs = document.getElementsByClassName('tab-content');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    var btns = document.getElementsByClassName('tab-btn');
    for (var i = 0; i < btns.length; i++) {
        btns[i].classList.remove('active');
    }
    document.getElementById(tabName).classList.add('active');
    evt.currentTarget.classList.add('active');
    
    if (tabName === 'testing') {
        renderEIsot();
        renderPrombez();
        renderNDTesting();
    }
    if (tabName === 'analytics') renderAnalytics();
    if (tabName === 'dashboard') renderDashboard();
    if (tabName === 'history') renderHistory();
    if (tabName === 'settings') {
        renderMainCategoriesManager();
        renderCategoriesManager();
        renderNdTestTypesManager();
    }
}

// ============= –ó–ê–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù =============
window.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
    }
});

// ============= –ó–ê–ü–£–°–ö =============
init();
</script>

</body>
</html>
